<!DOCTYPE html>
<html lang="zh-tw">
<head>
    <meta charset="UTF-8">
    <title>查看課表</title>
    <script>
        async function checkUserId() {
            let userId = document.getElementById('user_id').value;
            let actor = document.getElementById('actor').value;
            let response = await fetch('/api/check_user_id', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: userId, actor: actor})
            });
            let data = await response.json();
            if (data.status === 'not_exists') {
                alert('查無此學生');
                return false;
            }
            return true;
        }

        async function viewSchedule() {
            if (!await checkUserId()) return;

            let userId = document.getElementById('user_id').value;
            let actor = document.getElementById('actor').value;
            let confirm = window.confirm(`確認查詢學號 ${userId} 之學生課表？`);
            if (!confirm) return;

            let response = await fetch('/api/view_schedule', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: userId, actor: actor})
            });
            let data = await response.json();

            if (data.status === 'success') {
                let schedule = data.schedule;
                let scheduleDiv = document.getElementById('schedule');
                scheduleDiv.innerHTML = `
                    <h2>學號: ${userId}</h2>
                    <p>目前學分: ${data.current_credits}</p>
                    <p>最低學分: ${data.min_credits}</p>
                    <p>最高學分: ${data.max_credits}</p>
                    <table border="1">
                        <thead>
                            <tr>
                                <th>節次</th>
                                <th>星期一</th>
                                <th>星期二</th>
                                <th>星期三</th>
                                <th>星期四</th>
                                <th>星期五</th>
                                <th>星期六</th>
                                <th>星期日</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${[...Array(14).keys()].map(i => `
                                <tr>
                                    <td>第${i+1}節</td>
                                    ${[...Array(7).keys()].map(j => `
                                        <td id="cell-${i}-${j}"></td>
                                    `).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

                schedule.selected.forEach(course => {
                    course.schedule.forEach(time => {
                        let cell = document.getElementById(`cell-${time.period-1}-${time.day-1}`);
                        cell.innerHTML = course.code;
                        cell.style.backgroundColor = 'green';
                    });
                });

                if (actor !== 'admin') {
                    schedule.registered.forEach(course => {
                        course.schedule.forEach(time => {
                            let cell = document.getElementById(`cell-${time.period-1}-${time.day-1}`);
                            cell.innerHTML = course.code;
                            cell.style.backgroundColor = 'orange';
                        });
                    });

                    schedule.interested.forEach(course => {
                        course.schedule.forEach(time => {
                            let cell = document.getElementById(`cell-${time.period-1}-${time.day-1}`);
                            cell.innerHTML = course.code;
                            cell.style.backgroundColor = 'yellow';
                        });
                    });
                }
            }
        }
    </script>
</head>
<body>
    <h1>查看課表</h1>
    <form onsubmit="event.preventDefault(); viewSchedule();">
        <label for="user_id">學號：</label>
        <input type="text" id="user_id" name="user_id" required>
        <label for="actor">角色：</label>
        <select id="actor" name="actor" required>
            <option value="student">學生</option>
            <option value="admin">行政</option>
        </select>
        <button type="submit">查看課表</button>
    </form>
    <div id="schedule"></div>
</body>
</html>